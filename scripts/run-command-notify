#!/usr/bin/python

import argparse
import boto.ses
import subprocess
import sys
import traceback

if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('--from-address', required=True)
    parser.add_argument('--subject', required=True)
    parser.add_argument('--to-address', action='append')
    parser.add_argument('--cc-address', action='append')
    parser.add_argument('--bcc-address', action='append')

    config, args = parser.parse_known_args()

    try:
        out = subprocess.check_output(args, stderr=subprocess.STDOUT)
        sys.exit(0)
    except Exception as e:
        message = '* Command:     \'' + '\' \''.join(args) + '\'\n'
        if hasattr(e, 'returncode'):
            message += '* Exit status: %s\n\n' % e.returncode
        if hasattr(e, 'output'):
            message += '* Output:\n%s\n\n' % e.output
        message += '* %s' % traceback.format_exc()

    ses = boto.ses.connect_to_region('us-east-1')
    ses.send_email(config.from_address, config.subject, message,
            config.to_address, config.cc_address, config.bcc_address)
